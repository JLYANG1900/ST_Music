<div id="st-music-root">
    <div id="st-music-panel">
        <!-- 1. 标题栏 -->
        <div class="stm-header">
            <div class="stm-logo-title">
                <span class="stm-disc-icon"><i class="fa-solid fa-compact-disc"></i></span>
                <span class="stm-brand">BRAUN</span>
                <span class="stm-model">AUDIO 310</span>
            </div>
            <div class="stm-header-controls">
                <!-- 页面切换按钮 -->
                <button class="stm-tab-btn active" id="stm-tab-player" title="播放器"><i
                        class="fa-solid fa-headphones"></i><span class="stm-tab-text"> 播放器</span></button>
                <button class="stm-tab-btn" id="stm-tab-create" title="创作页面"><i class="fa-solid fa-palette"></i><span
                        class="stm-tab-text">
                        创作</span></button>
                <button class="stm-tab-btn" id="stm-tab-results" title="成果页面"><i
                        class="fa-solid fa-file-lines"></i><span class="stm-tab-text">
                        成果</span></button>
                <button class="stm-tab-btn" id="stm-tab-settings" title="API设置"><i class="fa-solid fa-gear"></i><span
                        class="stm-tab-text">
                        设置</span></button>
                <button class="stm-icon-btn" id="stm-btn-close" title="关闭">✕</button>
            </div>
        </div>

        <!-- 2. 主体区域 -->
        <div class="stm-body">
            <!-- 左侧：播放器区域 (两页共享) -->
            <div class="stm-player-section">
                <!-- 播放列表区域 (扬声器网格纹理背景) -->
                <div class="stm-playlist-area">
                    <div class="stm-playlist-overlay" id="stm-playlist">
                        <div class="stm-playlist-empty">
                            <span class="stm-music-icon"><i class="fa-solid fa-music"></i></span>
                            <span class="stm-empty-text">No Tape Loaded</span>
                        </div>
                    </div>
                </div>

                <!-- 播放控件 -->
                <div class="stm-player-controls">
                    <!-- 上传按钮 -->
                    <div class="stm-control-group">
                        <input type="file" id="stm-file-input" accept="audio/mp3,audio/*" multiple
                            style="display:none;">
                        <div class="stm-btn-row">
                            <button class="stm-ctrl-btn stm-upload-btn" id="stm-btn-upload" title="本地上传试听 (浏览器刷新后会消失)">
                                <i class="fa-solid fa-upload"></i>
                            </button>
                            <button class="stm-ctrl-btn" id="stm-btn-link" title="添加网络链接（浏览器刷新后可保留）">
                                <i class="fa-solid fa-link"></i>
                            </button>
                        </div>
                        <span class="stm-ctrl-label">Load / Link</span>
                    </div>

                    <!-- 播放控制组 -->
                    <div class="stm-playback-group">
                        <button class="stm-ctrl-btn" id="stm-btn-prev" title="上一曲">
                            <i class="fa-solid fa-backward-step"></i>
                        </button>
                        <button class="stm-ctrl-btn stm-play-btn" id="stm-btn-play" title="播放/暂停">
                            <i class="fa-solid fa-play" id="stm-play-icon"></i>
                        </button>
                        <button class="stm-ctrl-btn" id="stm-btn-next" title="下一曲">
                            <i class="fa-solid fa-forward-step"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 右侧：内容区域 -->
            <div class="stm-content-section">

                <!-- 创作页面 (默认显示) -->
                <div class="stm-page" id="stm-page-create">
                    <div class="stm-form-scroll">

                        <!-- 01 / Creator Profile -->
                        <div class="stm-form-group">
                            <label class="stm-label">01 / Creator Profile</label>
                            <div class="stm-input-wrapper">
                                <input type="text" id="stm-char-name" class="stm-input"
                                    placeholder="Enter Character Name...">
                                <span class="stm-hint">你想要让哪个角色来创作音乐？</span>
                            </div>
                        </div>

                        <!-- 02 / Vocal Range -->
                        <div class="stm-form-group">
                            <label class="stm-label">02 / Vocal Range</label>
                            <div class="stm-btn-grid stm-vocal-grid" id="stm-vocal-btns">
                                <!-- JS will populate -->
                            </div>
                            <!-- 性别子选项 (仅当选择"根据人设推断"时显示) -->
                            <div class="stm-gender-selector" id="stm-gender-selector" style="display:none;">
                                <span class="stm-gender-label">指定性别:</span>
                                <button class="stm-gender-btn" data-gender="男">男 (Male)</button>
                                <button class="stm-gender-btn" data-gender="女">女 (Female)</button>
                            </div>
                            <!-- 声部音色面板 -->
                            <div class="stm-timbre-panel" id="stm-timbre-panel">
                                <div class="stm-timbre-header">
                                    <span class="stm-music-icon"><i class="fa-solid fa-microphone"></i></span>
                                    <span class="stm-timbre-title">声部音色</span>
                                </div>
                                <div class="stm-btn-grid stm-timbre-grid" id="stm-timbre-btns">
                                    <!-- JS will populate -->
                                </div>
                            </div>
                            <p class="stm-note">* 如果不确定角色的音域，请选择最后一项由 AI 判断</p>
                        </div>

                        <!-- 03 / Musical Genre -->
                        <div class="stm-form-group">
                            <label class="stm-label">03 / Musical Genre</label>
                            <div class="stm-btn-grid stm-genre-grid" id="stm-genre-btns">
                                <!-- JS will populate main genres -->
                            </div>
                            <!-- 子流派面板 -->
                            <div class="stm-subgenre-panel" id="stm-subgenre-panel" style="display:none;">
                                <div class="stm-subgenre-header">
                                    <span class="stm-music-icon"><i class="fa-solid fa-sliders"></i></span>
                                    <span class="stm-subgenre-title">Sub-Genre</span>
                                    <span class="stm-genre-desc" id="stm-genre-desc"></span>
                                </div>
                                <div class="stm-btn-grid stm-subgenre-grid" id="stm-subgenre-btns">
                                    <!-- JS will populate sub genres -->
                                </div>
                            </div>
                        </div>

                        <!-- 04 / Lead Instrument -->
                        <div class="stm-form-group" id="stm-instrument-group" style="display:none;">
                            <label class="stm-label">04 / Lead Instrument</label>
                            <div class="stm-instrument-container" id="stm-instrument-btns">
                                <!-- JS will populate -->
                            </div>
                        </div>

                        <!-- 05 / Lyrics Concept -->
                        <div class="stm-form-group">
                            <label class="stm-label">05 / Lyrics Concept</label>
                            <div class="stm-lyrics-panel" id="stm-lyrics-panel">
                                <!-- 歌词语言 -->
                                <div class="stm-lyrics-section">
                                    <div class="stm-lyrics-section-header">
                                        <span class="stm-music-icon"><i class="fa-solid fa-language"></i></span>
                                        <span class="stm-lyrics-section-title">歌词语言</span>
                                    </div>
                                    <div class="stm-btn-grid stm-lang-grid" id="stm-lang-btns">
                                        <!-- JS will populate -->
                                    </div>
                                    <input type="text" id="stm-lang-custom" class="stm-lyrics-custom-input"
                                        placeholder="其他语言...">
                                </div>

                                <!-- 创作模式 -->
                                <div class="stm-lyrics-section">
                                    <div class="stm-lyrics-section-header">
                                        <span class="stm-music-icon"><i class="fa-solid fa-pen-nib"></i></span>
                                        <span class="stm-lyrics-section-title">歌词内容</span>
                                    </div>
                                    <div class="stm-btn-grid stm-mode-grid" id="stm-lyric-mode-btns">
                                        <!-- JS will populate -->
                                    </div>
                                    <input type="text" id="stm-lyric-keywords" class="stm-lyrics-custom-input"
                                        placeholder="输入你想要的歌词关键词...">
                                </div>

                                <!-- 韵脚方案 -->
                                <div class="stm-lyrics-section">
                                    <div class="stm-lyrics-section-header">
                                        <span class="stm-music-icon"><i class="fa-solid fa-headphones"></i></span>
                                        <span class="stm-lyrics-section-title">韵脚方案</span>
                                    </div>
                                    <div class="stm-btn-grid stm-rhyme-grid" id="stm-rhyme-btns">
                                        <!-- JS will populate -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 06 / Other Requirements -->
                        <div class="stm-form-group">
                            <label class="stm-label">06 / Other Requirements</label>
                            <div class="stm-other-req-row">
                                <input type="text" id="stm-other-requirements" class="stm-input"
                                    placeholder="可填写对于作曲的其他特殊要求，例如指定某种乐器开场。">
                                <button class="stm-toggle-btn stm-dice-btn" id="stm-btn-dice-req" title="随机填入">
                                    <i class="fa-solid fa-dice"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 07 / Output Mode -->
                        <div class="stm-form-group">
                            <label class="stm-label">07 / Output Mode</label>
                            <span
                                class="stm-output-mode-text">1.只生成创作笔记：请在插件内配置API，然后点击羽毛按钮进入预览页面。<br>2.嵌入正文：请点击橙色播放键，提示词会进入酒馆的输入框。建议搭配正则脚本：regex-ST_Music_不发送创作笔记，可以使创作笔记不进入正文的上下文、避免浪费token。若希望正文中出现关于创作笔记的剧情，可不开启该正则脚本。</span>
                        </div>

                        <!-- 生成按钮区域 -->
                        <div class="stm-action-footer">
                            <div class="stm-author-info">
                                插件作者 · JLYANG1900 · https://github.com/JLYANG1900
                            </div>
                            <button class="stm-create-btn stm-note-only-btn" id="stm-btn-generate-note"
                                title="独立API：只生成创作笔记">
                                <i class="fa-solid fa-feather-pointed"></i>
                            </button>
                            <button class="stm-create-btn" id="stm-btn-generate" title="发送至SillyTavern">
                                <i class="fa-solid fa-play"></i>
                            </button>
                        </div>

                    </div>
                </div>

                <!-- 成果页面 (切换显示) -->
                <div class="stm-page" id="stm-page-results" style="display:none;">
                    <div class="stm-results-container">
                        <div class="stm-results-header">
                            <span class="stm-results-icon"><i class="fa-solid fa-pen-to-square"></i></span>
                            <span class="stm-results-title">Creation Notes</span>
                            <button class="stm-history-btn" id="stm-btn-history" title="历史记录">
                                <i class="fa-solid fa-clock-rotate-left"></i> 历史
                            </button>
                        </div>

                        <!-- 加载状态指示器 -->
                        <div class="stm-loading-indicator" id="stm-loading-indicator" style="display:none;">
                            <i class="fa-solid fa-spinner fa-spin"></i> 正在生成创作笔记...
                        </div>

                        <!-- 歌名显示 -->
                        <div class="stm-result-section">
                            <div class="stm-result-label">一、歌名</div>
                            <div class="stm-result-content" id="stm-result-title">
                                <span class="stm-placeholder">等待 LLM 返回创作笔记...</span>
                            </div>
                        </div>

                        <!-- 歌词显示 -->
                        <div class="stm-result-section">
                            <div class="stm-result-label-row">
                                <span>二、歌词结构</span>
                                <button class="stm-copy-btn" id="stm-copy-lyrics" title="复制歌词">
                                    <i class="fa-solid fa-copy"></i> 复制歌词
                                </button>
                            </div>
                            <div class="stm-result-content stm-lyrics-content" id="stm-result-lyrics">
                                <span class="stm-placeholder">等待 LLM 返回创作笔记...</span>
                            </div>
                        </div>

                        <!-- 风格显示 -->
                        <div class="stm-result-section">
                            <div class="stm-result-label-row">
                                <span>三、风格</span>
                                <button class="stm-copy-btn" id="stm-copy-style" title="复制风格">
                                    <i class="fa-solid fa-copy"></i> 复制风格
                                </button>
                            </div>
                            <div class="stm-result-content" id="stm-result-style">
                                <span class="stm-placeholder">等待 LLM 返回创作笔记...</span>
                            </div>
                        </div>

                        <!-- 刷新按钮 -->
                        <div class="stm-results-footer">
                            <button class="stm-refresh-btn" id="stm-btn-refresh-notes">
                                <i class="fa-solid fa-rotate"></i> 刷新捕捉
                            </button>
                        </div>
                    </div>

                    <!-- 历史记录面板（覆盖层，放在 stm-results-container 外面） -->
                    <div class="stm-history-overlay" id="stm-history-overlay" style="display:none;">
                        <div class="stm-history-header">
                            <span class="stm-history-title"><i class="fa-solid fa-clock-rotate-left"></i>
                                最近8条历史记录</span>
                            <button class="stm-history-close" id="stm-history-close" title="关闭历史">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <div class="stm-history-list" id="stm-history-list">
                            <div class="stm-history-empty">暂无历史记录</div>
                        </div>
                    </div>

                    <!-- 预览面板（覆盖层，放在 stm-results-container 外面） -->
                    <div class="stm-history-overlay stm-preview-overlay" id="stm-preview-overlay" style="display:none;">
                        <div class="stm-history-header">
                            <span class="stm-history-title"><i class="fa-solid fa-eye"></i>
                                发送预览</span>
                            <div class="stm-preview-actions">
                                <span class="stm-token-count" id="stm-token-count" title="估算 Token 数"><i
                                        class="fa-solid fa-coins"></i> <span id="stm-token-count-value">--</span></span>
                                <button class="stm-toggle-btn stm-preview-confirm-btn" id="stm-preview-confirm"
                                    title="确认发送">
                                    <i class="fa-solid fa-paper-plane"></i> 发送
                                </button>
                                <button class="stm-history-close" id="stm-preview-close" title="取消">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                        <div class="stm-history-list" id="stm-preview-list">
                        </div>
                    </div>
                </div>

                <!-- 设置页面 (Tab切换显示) -->
                <div class="stm-page" id="stm-page-settings" style="display:none;">
                    <!-- JS will populate via MusicSettings.createSettingsPage() -->
                </div>

            </div>
            <!-- Link Input Modal -->
            <div id="stm-link-modal" class="stm-modal-overlay" style="display: none;">
                <div class="stm-modal-content">
                    <div class="stm-modal-header">
                        <h3>添加新歌曲</h3>
                    </div>
                    <div class="stm-modal-body">
                        <div class="stm-form-group">
                            <label for="stm-link-url">链接</label>
                            <input type="text" id="stm-link-url" placeholder="https://files.catbox.moe/XXXXXX.mp3">
                        </div>
                        <div class="stm-form-group">
                            <label for="stm-link-name">歌名</label>
                            <input type="text" id="stm-link-name" placeholder="请填写歌曲名">
                        </div>
                    </div>
                    <div class="stm-modal-footer">
                        <button id="stm-modal-cancel" class="stm-btn-secondary">取消</button>
                        <button id="stm-modal-confirm" class="stm-btn-primary">添加歌曲</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 隐藏的音频播放器 -->
    <audio id="stm-audio-player"></audio>
</div>